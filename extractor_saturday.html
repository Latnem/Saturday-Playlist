<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Playlist Extractor — Saturday (Public Talk & Watchtower)</title>
  <style>
    :root{ --bg:#ffffff; --text:#0b0c10; --muted:#6b7280; --muted-2:#9ca3af; --border:#e5e7eb; --row:#fbfbfb; --row-alt:#f7f7f7; --done:#9ca3af; --primary:#059669; --primary-ink:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui; color:var(--text); background:#fff;}
    .container{max-width:980px;margin:24px auto 80px;padding:0 16px;}
    .dropzone{border:2px dashed #cfd3dc;border-radius:16px;padding:20px;display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center;color:var(--muted);}
    .dz-icon{width:42px;height:42px;opacity:.9;}
    input[type="file"]{display:none;}
    .filemeta{margin-top:6px;color:var(--muted-2);font-size:.9rem;}
    .controls{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:6px;}
    .btn{border:1px solid var(--border);background:#fff;color:var(--text);border-radius:10px;padding:7px 12px;cursor:pointer;font-weight:700;}
    .btn[disabled]{opacity:.5;cursor:not-allowed;}
    .btn-primary{background:var(--primary);color:var(--primary-ink);border-color:#047857;}
    .error{margin:14px 0;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;white-space:pre-wrap;}
    .results{margin-top:18px;border:1px solid var(--border);border-radius:14px;overflow:hidden;}
    .results header{padding:12px 14px;border-bottom:1px solid var(--border);background:#fafafa;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .header-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .toggle{display:inline-flex;align-items:center;gap:8px;font-size:.95rem;}
    table{width:100%;border-collapse:collapse;}
    th,td{border-top:1px solid var(--border);padding:10px 12px;text-align:left;vertical-align:middle;}
    tbody tr:nth-child(odd){background:#fbfbfb;}
    tbody tr:nth-child(even){background:#f7f7f7;}
    tbody tr:hover{background:#eef2ff;}
    .col-check{width:44px;}
    tr.done td:nth-child(2){ text-decoration: line-through; color: var(--done); }
    .insert-row td{font-weight:800;}

    /* Back arrow button (twin to Tuesday) */
    .back-btn{
      display:inline-flex;align-items:center;justify-content:center;
      width:34px;height:34px;border-radius:8px;
      border:1px solid var(--border);background:#fff;color:#111827;
      cursor:pointer;font-size:18px;line-height:1;
    }
    .back-btn:hover{background:#f3f4f6;}
    .back-btn:focus{outline:2px solid #93c5fd; outline-offset:2px;}
    .muted{color:var(--muted);}
  </style>
</head>
<body>
  <div class="container">
    <div id="dropzone" class="dropzone">
      <svg class="dz-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 16V4" stroke-width="2"/><path d="M7 9l5-5 5 5" stroke-width="2"/><rect x="3" y="16" width="18" height="5" rx="2" stroke-width="2"></rect></svg>
      <label for="fileInput" class="btn">Choose File</label>
      <input id="fileInput" type="file" accept=".jwlplaylist,.jwlibrary,.zip,application/zip,application/octet-stream" />
      <div id="fileMeta" class="filemeta"></div>
      <div class="controls">
        <button id="extractBtn" class="btn btn-primary" disabled>Extract</button>
      </div>
    </div>

    <div id="errorBox" class="error" hidden></div>

    <section id="results" class="results" hidden>
      <header>
        <div class="header-left">
          <button id="backBtn" class="back-btn" title="Back" aria-label="Back" hidden>←</button>
          <label class="toggle"><input id="toggleInserts" type="checkbox" checked> Inserts</label>
          <span class="muted">Saturday</span>
        </div>
        <span id="resultCount" class="muted">0 items</span>
      </header>
      <table id="labelsTable">
        <thead>
          <tr><th class="col-check"></th><th></th></tr> <!-- Removed "Results" -->
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script>
    const fileInput=document.getElementById('fileInput'),
      extractBtn=document.getElementById('extractBtn'),
      errorBox=document.getElementById('errorBox'),
      results=document.getElementById('results'),
      resultCount=document.getElementById('resultCount'),
      tbody=document.querySelector('#labelsTable tbody'),
      toggleInserts=document.getElementById('toggleInserts'),
      dropzone=document.getElementById('dropzone'),
      backBtn=document.getElementById('backBtn');

    let chosenFile=null, baseLabels=[], showInserts=true;

    function clearError(){errorBox.hidden=true;errorBox.textContent='';}
    function showError(m){errorBox.textContent=m;errorBox.hidden=false;}
    function updateFileMeta(){document.getElementById('fileMeta').textContent=chosenFile?`${chosenFile.name} • ${(chosenFile.size/1024).toFixed(1)} KB`:"";}

    toggleInserts.addEventListener('change',()=>{ showInserts = toggleInserts.checked; render(); });

    fileInput.addEventListener('change',e=>{
      chosenFile=e.target.files[0];
      extractBtn.disabled=!chosenFile;
      updateFileMeta();
    });

    // Back arrow: show uploader, hide results
    backBtn.addEventListener('click', ()=>{
      results.hidden = true;
      backBtn.hidden = true;
      dropzone.hidden = false;
      dropzone.style.display = ''; // reset
      dropzone.setAttribute('aria-hidden','false');
      // Clear table
      tbody.innerHTML = '';
      resultCount.textContent = '0 items';
      baseLabels = [];
      // allow re-selecting a new file
      fileInput.value = '';
      extractBtn.disabled = true;
    });

    extractBtn.addEventListener('click',async()=>{
      clearError();tbody.innerHTML="";baseLabels=[];

      // Robust immediate hide of upload area
      dropzone.hidden = true;
      dropzone.style.display = 'none';
      dropzone.setAttribute('aria-hidden','true');

      // Show results area and back arrow right away
      results.hidden = false;
      backBtn.hidden = false;

      try{
        const buf=await chosenFile.arrayBuffer();
        const zip=await JSZip.loadAsync(buf);
        const dbEntry=Object.values(zip.files).find(f=>!f.dir&&f.name.toLowerCase().endsWith('.db'));
        if(!dbEntry) throw new Error('No .db file found inside the archive.');
        const dbArrayBuffer=await dbEntry.async('arraybuffer');
        const SQL=await initSqlJs({ locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}`});
        const db=new SQL.Database(new Uint8Array(dbArrayBuffer));

        const {labels}=extractFromEndAction(db);
        baseLabels=labels.slice();
        render();
      }catch(e){
        // If failed, restore uploader
        results.hidden = true;
        backBtn.hidden = true;
        dropzone.hidden = false;
        dropzone.style.display = '';
        dropzone.setAttribute('aria-hidden','false');
        showError(e.message||String(e));
      }
    });

    // ===== EndAction-driven extraction with corrected mapping; Continue merges THROUGH first Freeze/Stop =====
    function extractFromEndAction(db){
      function tableExists(name){
        try{
          const r = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND lower(name)=lower('${name}')`);
          return !!(r[0] && r[0].values && r[0].values.length);
        }catch{return false;}
      }
      if(!tableExists('PlaylistItem')) return { labels: [] };

      const cols = getColumns(db, 'PlaylistItem');
      const lower = cols.map(c=>c.name.toLowerCase());

      const labelCol = pickFirst(lower, ['label','title','name','displayname','caption']) || 'label';
      const orderCol = pickFirst(lower, ['order','orderindex','sort','sortindex','position','sequence','index','rowid']);
      const endActionLower = 'endaction';
      const hasEA = lower.includes(endActionLower);
      const endActionReal = hasEA ? getRealName(cols, endActionLower) : null;

      const sel = ['rowid AS __rowid', `"${getRealName(cols,labelCol)}" AS __label`];
      if(orderCol) sel.push(`"${getRealName(cols,orderCol)}" AS __ord`);
      if(hasEA) sel.push(`"${endActionReal}" AS __ea`);
      const sql = `SELECT ${sel.join(', ')} FROM "PlaylistItem"`;

      const rows = rowsFromExec(db.exec(sql)).sort((a,b)=>{
        const ao = (a.__ord ?? a.__rowid) ?? 0;
        const bo = (b.__ord ?? b.__rowid) ?? 0;
        return ao - bo;
      });

      const norm = rows.map(r => ({
        label: (r.__label ?? '').toString().trim(),
        action: remapEndAction(r.__ea) // actual: 'continue' | 'freeze' | 'stop' | 'unknown'
      }));

      const SEP = ' \u2192 ';
      const out = [];
      let i=0;
      while(i < norm.length){
        const cur = norm[i];
        if(!cur.label){ i++; continue; }

        // Freeze/Stop outside a chain => standalone
        if(cur.action === 'freeze' || cur.action === 'stop'){
          out.push(cur.label);
          i++;
          continue;
        }

        // Continue => merge forward through Continues AND INCLUDE first Freeze/Stop as terminator
        if(cur.action === 'continue'){
          const parts = [cur.label];
          let j = i + 1;
          while(j < norm.length){
            const nxt = norm[j];
            if(!nxt.label){ j++; continue; }
            if(nxt.action === 'continue'){
              parts.push(nxt.label);
              j++;
              continue;
            }
            if(nxt.action === 'freeze' || nxt.action === 'stop'){
              parts.push(nxt.label); // include terminator
              j++; // consume it
              break;
            }
            break;
          }
          out.push(parts.join(SEP));
          i = j;
          continue;
        }

        // Unknown/other => standalone
        out.push(cur.label);
        i++;
      }

      return { labels: out };
    }

    // ===== Helpers =====
    function getColumns(db, table){
      const out = [];
      try{
        const r = db.exec(`PRAGMA table_info("${table}")`);
        const rows = rowsFromExec(r);
        rows.forEach(row => out.push({ name: row.name, type: row.type }));
      }catch{}
      return out;
    }
    function getRealName(cols, lowerName){
      const m = cols.find(c => c.name.toLowerCase() === lowerName);
      return m ? m.name : lowerName;
    }
    function pickFirst(list, candidates){
      for(const c of candidates){
        const exact = list.indexOf(c);
        if(exact !== -1) return list[exact];
        const pref = list.find(n => n.startsWith(c));
        if(pref) return pref;
      }
      return null;
    }
    function rowsFromExec(execResult){
      if(!execResult || !execResult.length) return [];
      const r = execResult[0];
      const cols = r.columns || [];
      const out = [];
      for(const v of (r.values||[])){
        const obj = {};
        cols.forEach((c,idx)=> obj[c] = v[idx]);
        out.push(obj);
      }
      return out;
    }

    function remapEndAction(val){
      let dbMeaning = 'unknown';
      if(val != null){
        const s = String(val).trim().toLowerCase();
        if(!Number.isNaN(Number(s))){
          const n = Number(s);
          if(n === 0) dbMeaning = 'stop';
          else if(n === 1) dbMeaning = 'pause';
          else if(n === 2) dbMeaning = 'continue';
          else if(n === 3) dbMeaning = 'freeze';
        }else{
          if(['0','stop','stopped','end'].includes(s)) dbMeaning = 'stop';
          else if(['1','pause'].includes(s)) dbMeaning = 'pause';
          else if(['2','continue','autoplay','playthrough'].includes(s)) dbMeaning = 'continue';
          else if(['3','freeze','freeze-frame','freeze_frame','hold'].includes(s)) dbMeaning = 'freeze';
        }
      }
      // Correction mapping
      if(dbMeaning === 'continue') return 'freeze';
      if(dbMeaning === 'stop') return 'continue';
      if(dbMeaning === 'freeze') return 'stop';
      if(dbMeaning === 'pause') return 'freeze';
      return 'unknown';
    }

    // ===== Saturday Auto Inserts (with Public Talk & Watchtower) =====
    function applyAutoInserts(list){
      if(!showInserts) return list.map(t => ({__insert:false, text:t}));

      const withInserts = list.map(t => ({__insert:false, text:t}));

      // Insert OPENING SONG at top
      withInserts.splice(0,0,{__insert:true, text:'OPENING SONG'});

      // Insert PUBLIC TALK at line 3 (index 2)
      const publicTalkIndex = Math.min(2, withInserts.length);
      withInserts.splice(publicTalkIndex, 0, {__insert:true, text:'PUBLIC TALK'});

      // Detect the next numbered item (1. .. 162.) after PUBLIC TALK
      const reNum = /(?:^|\s)(?:1[0-5]\d|16[0-2]|[1-9]\d|[1-9])\.(?=\s|$)/;
      let nextNumberIdx = -1;
      for(let i=publicTalkIndex+1; i<withInserts.length; i++){
        const entry = withInserts[i];
        if(entry.__insert) continue;
        if(reNum.test(entry.text)) { nextNumberIdx = i; break; }
      }

      if(nextNumberIdx !== -1){
        // Insert MIDDLE SONG before that next numbered item
        withInserts.splice(nextNumberIdx, 0, {__insert:true, text:'MIDDLE SONG'});
        // After insertion, numbered item shifts to nextNumberIdx+1
        // Insert WATCHTOWER after the numbered item => at nextNumberIdx+2
        withInserts.splice(nextNumberIdx+2, 0, {__insert:true, text:'WATCHTOWER'});
      }

      // Insert CLOSING SONG as second last line
      const pos = Math.max(0, withInserts.length - 1);
      withInserts.splice(pos, 0, {__insert:true, text:'CLOSING SONG'});

      return withInserts;
    }

    // ===== Rendering =====
    function onCheckChange(e){
      const cb = e.target;
      if(!cb.classList.contains('row-check')) return;
      const tr = cb.closest('tr');
      if(!tr) return;
      tr.classList.toggle('done', cb.checked);
    }

    function render(){
      const rendered = applyAutoInserts(baseLabels);
      tbody.innerHTML='';
      rendered.forEach((entry,i)=>{
        const isInsert = entry.__insert === true;
        const text = entry.text;

        const tr=document.createElement('tr');
        tr.dataset.row=i;
        if(isInsert) tr.classList.add('insert-row');

        const tdCheck=document.createElement('td');
        tdCheck.className='col-check';
        if(!isInsert){
          const cb=document.createElement('input');
          cb.type='checkbox';cb.className='row-check';
          cb.addEventListener('change', onCheckChange);
          tdCheck.appendChild(cb);
        }
        tr.appendChild(tdCheck);

        const td=document.createElement('td');
        td.textContent=text;
        tr.appendChild(td);

        tbody.appendChild(tr);
      });
      resultCount.textContent=`${rendered.length} ${rendered.length===1?'item':'items'}`;
    }
  </script>
</body>
</html>
